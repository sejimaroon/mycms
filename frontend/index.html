<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP FAKE</title>
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>
  <header class="header">
    <div class="header__inner">
      <h1 class="header__logo">
        <a href="/frontend/index.html">WP FAKE</a>
      </h1>
    </div>
  </header>
  <div class="mv"></div>
  <main class="main">
    <div id="dynamic-sections">読み込み中...</div>
    
    <!-- 設定ファイルを読み込み -->
    <script src="../config.js"></script>
    
    <script>
      // API設定を取得（環境自動判定）
      const API_BASE_URL = window.API_CONFIG.getBaseURL();
      console.log(`Using API: ${API_BASE_URL}`);

      async function renderSections() {
        try {
          const [sectionsRes, postsRes] = await Promise.all([
            fetch(`${API_BASE_URL}/api/sections`),
            fetch(`${API_BASE_URL}/api/posts`)
          ]);

          allSections = await sectionsRes.json();
          allPosts = await postsRes.json();

          const container = document.getElementById("dynamic-sections");

          const sectionsWithPosts = allSections.map(section => {
            const sectionPosts = allPosts
              .filter(post => post.sectionId === section.id)
              .sort((a, b) => {
                const dateA = new Date(a.date || 0);
                const dateB = new Date(b.date || 0);
                return dateB - dateA;
              });
            return { ...section, posts: sectionPosts };
          });

          container.innerHTML = sectionsWithPosts.map(section => renderSection(section)).join("");

        } catch (err) {
          document.getElementById("dynamic-sections").innerText = "投稿の読み込みに失敗しました";
          console.error(err);
        }
      }

      function renderSection(section) {
        const displayPosts = section.posts.slice(0, 6);
        const hasMore = section.posts.length > 6;

        return `
          <section class="section section--id-${section.id}" data-section-id="${section.id}" style="border-color: ${section.style.borderColor};">
            <h2 class="section__title section__title--id-${section.id}" style="color: ${section.style.titleColor};">${escapeHtml(section.name)}</h2>
            <div class="post__container post__container--id-${section.id}">
              ${displayPosts.length > 0
            ? displayPosts.map(post => renderPostPreview(post, section.style)).join("")
            : `<p class="section__empty-message section__empty-message--id-${section.id}" style="color: ${section.style.contentColor};">このセクションにはまだ投稿がありません</p>`
          }
            </div>
            ${hasMore ? `
              <div class="section__footer section__footer--id-${section.id}">
                <button class="section__view-all-btn section__view-all-btn--id-${section.id}" onclick="navigateTo('#/section/${section.id}')" style="background-color: ${section.style.titleColor};">
                  一覧を見る (${section.posts.length}件)
                </button>
              </div>
            ` : ""}
          </section>
        `;
      }

      function resolveSectionMvUrl(section) {
        let p = null;
        if (section && section.style && typeof section.style.mvImage === 'string' && section.style.mvImage.trim()) {
          p = section.style.mvImage.trim();
        } else if (section && typeof section.mvImage === 'string' && section.mvImage.trim()) {
          p = section.mvImage.trim();
        } else if (section && section.id != null) {
          p = `../images/mv-${section.id}.jpg`;
        }

        if (!p) return null;
        const isAbsolute = /^(https?:)?\/\//.test(p) || p.startsWith('data:') || p.startsWith('blob:') || p.startsWith('/') || p.startsWith('../') || p.startsWith('./');
        return isAbsolute ? p : `../images/${p}`;
      }

      function updateMVForSection(section) {
        const mv = document.querySelector('.mv');
        if (!mv) return;

        if (!section) {
          mv.style.backgroundImage = '';
          return;
        }

        const url = resolveSectionMvUrl(section);
        if (!url) {
          mv.style.backgroundImage = '';
          return;
        }

        const img = new Image();
        img.onload = () => {
          mv.style.backgroundImage = `url('${url}')`;
        };
        img.onerror = () => {
          mv.style.backgroundImage = '';
        };
        img.src = url;
      }

      // API_CONFIGを使用して画像URLを処理
      function prefixImageUrl(url) {
        return window.API_CONFIG.getImageURL(url);
      }

      function extractTextFromBlocks(blocks) {
        const lines = [];
        const walk = (node) => {
          if (!node) return;
          if (Array.isArray(node)) { node.forEach(walk); return; }
          if (node.type === 'heading' || node.type === 'paragraph') {
            if (node.content) lines.push(String(node.content));
          } else if (node.type === 'columns') {
            if (Array.isArray(node.children)) node.children.forEach(col => Array.isArray(col) && col.forEach(walk));
          } else if (node.type === 'grid') {
            if (Array.isArray(node.children)) node.children.forEach(walk);
          }
        };
        walk(blocks);
        return lines.join('\n');
      }

      function getFirstBlockImage(blocks) {
        let found = null;
        const walk = (node) => {
          if (found) return;
          if (!node) return;
          if (Array.isArray(node)) { node.forEach(walk); return; }
          if (node.type === 'image' && node.url) { found = node.url; return; }
          if (node.type === 'columns' && Array.isArray(node.children)) {
            node.children.forEach(col => Array.isArray(col) && col.forEach(walk));
          } else if (node.type === 'grid' && Array.isArray(node.children)) {
            node.children.forEach(walk);
          }
        };
        walk(blocks);
        return found;
      }

      function renderBlocks(blocks, sectionId = null) {
        const renderBlock = (b, index) => {
          if (!b) return '';
          const blockId = b.id || `block-${index}`;
          const sectionClass = sectionId ? `section-${sectionId}` : '';

          if (b.type === 'heading') {
            const level = Math.min(6, Math.max(1, Number(b.level) || 2));
            return `<h${level} class="block block--heading block--heading-${level} block--${sectionClass}" data-block-id="${blockId}" data-block-type="heading">${escapeHtml(b.content || '')}</h${level}>`;
          }
          if (b.type === 'paragraph') {
            return `<p class="block block--paragraph block--${sectionClass}" data-block-id="${blockId}" data-block-type="paragraph">${escapeHtml(b.content || '')}</p>`;
          }
          if (b.type === 'image') {
            const src = prefixImageUrl(b.url);
            const alt = escapeHtml(b.alt || '');
            return src ? `<div class="block block--image block--${sectionClass}" data-block-id="${blockId}" data-block-type="image"><img src="${src}" alt="${alt}" class="block__image" style="max-width:100%;"></div>` : '';
          }
          if (b.type === 'columns') {
            const cols = Array.isArray(b.children) ? b.children : [];
            const columnCount = cols.length;
            return `<div class="block block--columns block--columns-${columnCount} block--${sectionClass}" data-block-id="${blockId}" data-block-type="columns" style="display:flex; gap:12px;">
              ${cols.map((col, colIndex) => `<div class="block__column block__column--${colIndex + 1}" style="flex:1;">${renderBlocks(col || [], sectionId)}</div>`).join('')}
            </div>`;
          }
          if (b.type === 'grid') {
            const children = Array.isArray(b.children) ? b.children : [];
            const cols = Number(b.cols) || 3;
            const gap = Number(b.gap) || 16;
            return `<div class="block block--grid block--grid-cols-${cols} block--${sectionClass}" data-block-id="${blockId}" data-block-type="grid" data-grid-cols="${cols}" data-grid-gap="${gap}" style="display:grid; grid-template-columns: repeat(${cols}, 1fr); gap:${gap}px;">
              ${children.map((child, childIndex) => `<div class="block__grid-item block__grid-item--${childIndex + 1}">${renderBlocks([child], sectionId)}</div>`).join('')}
            </div>`;
          }
          return '';
        };
        return (Array.isArray(blocks) ? blocks : []).map(renderBlock).join('');
      }

      function renderExcerptBlocks(blocks, sectionId = null) {
        if (!blocks) return '';
        const output = [];

        const walk = (b, index) => {
          if (!b) return;
          const blockId = b.id || `block-${index}`;
          const sectionClass = sectionId ? `section-${sectionId}` : '';

          if (b.type === 'heading') {
            const level = Math.min(6, Math.max(1, Number(b.level) || 2));
            output.push(`<p class="excerpt excerpt--heading excerpt--${sectionClass}" data-block-id="${blockId}">${escapeHtml(b.content || '')}</p>`);
          } else if (b.type === 'paragraph') {
            output.push(`<p class="excerpt excerpt--paragraph excerpt--${sectionClass}" data-block-id="${blockId}">${escapeHtml(b.content || '')}</p>`);
          } else if (b.type === 'image') {
            const src = prefixImageUrl(b.url);
            if (src) {
              output.push(`<div class="excerpt excerpt--image excerpt--${sectionClass}" data-block-id="${blockId}"><img src="${src}" class="excerpt__image" style="max-width:100%;"></div>`);
            }
          } else if (b.type === 'columns' && Array.isArray(b.children)) {
            b.children.forEach(col => {
              if (Array.isArray(col)) {
                col.forEach((child, i) => walk(child, i));
              } else {
                walk(col, 0);
              }
            });
          } else if (b.type === 'grid' && Array.isArray(b.children)) {
            b.children.forEach((child, i) => walk(child, i));
          }
        };

        (Array.isArray(blocks) ? blocks : []).forEach((b, i) => walk(b, i));
        return output.join('');
      }

      function renderPostPreview(post, sectionStyle) {
        const textSource = Array.isArray(post.blocks) ? extractTextFromBlocks(post.blocks) : (post.content || '');
        const excerpt = textSource.substring(0, 100) + (textSource.length > 100 ? '...' : '');
        const idEnc = encodeURIComponent(String(post.id));

        const excerptHtml = Array.isArray(post.blocks)
          ? renderExcerptBlocks(post.blocks, post.sectionId)
          : `<p class="excerpt excerpt--paragraph excerpt--section-${post.sectionId}">${escapeHtml(post.content || '')}</p>`;

        return `
    <article class="post__preview post__preview--section-${post.sectionId}" data-post-id="${post.id}" data-section-id="${post.sectionId}">
      <h3 class="post__title post__title--section-${post.sectionId}">
        <a href="#/post/${idEnc}" onclick="navigateTo('#/post/${idEnc}'); return false;" class="post__title-link post__title-link--section-${post.sectionId}" style="color: ${sectionStyle.titleColor};">${escapeHtml(post.title || 'タイトル未設定')}</a>
      </h3>
      <p class="post__date post__date--section-${post.sectionId}" style="color: ${sectionStyle.contentColor};">${escapeHtml(post.date || '')}</p>
      <div class="post__excerpt post__excerpt--section-${post.sectionId}" style="color: ${sectionStyle.contentColor};">
        ${excerptHtml}
      </div>
      <a href="#/post/${idEnc}" onclick="navigateTo('#/post/${idEnc}'); return false;" class="post__read-more-link post__read-more-link--section-${post.sectionId}" style="color: ${sectionStyle.titleColor};">続きを読む →</a>
    </article>
  `;
      }

      function renderPost(post, sectionStyle) {
        const contentHtml = Array.isArray(post.blocks) ? renderBlocks(post.blocks, post.sectionId) : escapeHtml(post.content || "");

        const imageHtml = post.image ? `
          <div class="post__image post__image--section-${post.sectionId}">
            <img src="${prefixImageUrl(post.image)}" alt="${escapeHtml(post.title)}" style="max-width:100%;">
          </div>
        ` : "";
        return `
          <article class="post post--section-${post.sectionId}" data-post-id="${post.id}" data-section-id="${post.sectionId}">
            <h3 class="post__title post__title--section-${post.sectionId}" style="color: ${sectionStyle.titleColor};">${escapeHtml(post.title || "タイトル未設定")}</h3>
            ${imageHtml}
            <div class="post__content post__content--section-${post.sectionId}" style="color: ${sectionStyle.contentColor};">${contentHtml}</div>
            <p class="post__date post__date--section-${post.sectionId}" style="color: ${sectionStyle.contentColor};">${escapeHtml(post.date || "")}</p>
          </article>
        `;
      }

      let currentView = 'home';
      let allSections = [];
      let allPosts = [];

      function handleRouting() {
        const hash = window.location.hash;
        if (hash.startsWith('#/post/')) {
          const postId = decodeURIComponent(hash.replace('#/post/', ''));
          showPostDetail(postId);
        } else if (hash.startsWith('#/section/')) {
          const sectionId = parseInt(hash.replace('#/section/', ''));
          viewAllPosts(sectionId);
        } else {
          updateMVForSection(null);
          renderSections();
        }
      }

      function navigateTo(hash) {
        window.location.hash = hash;
      }

      function goBack() {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          navigateTo('');
        }
      }

      async function showPostDetail(postId) {
        try {
          const post = allPosts.find(p => String(p.id) === String(postId));
          const section = allSections.find(s => s.id === post.sectionId);

          if (!post) {
            document.getElementById('dynamic-sections').innerHTML = '<p>投稿が見つかりません</p>';
            return;
          }

          updateMVForSection(section);
          const container = document.getElementById('dynamic-sections');

          container.innerHTML = `
            <div class="post__detail-container post__detail-container--section-${section.id}">
              <nav class="breadcrumb breadcrumb--section-${section.id}">
                <a href="#" onclick="navigateTo(''); return false;" class="breadcrumb__link breadcrumb__link--home">ホーム</a> /
                <a href="#/section/${section.id}" onclick="navigateTo('#/section/${section.id}'); return false;" class="breadcrumb__link breadcrumb__link--section">${escapeHtml(section.name)}</a> /
                <span class="breadcrumb__current">${escapeHtml(post.title)}</span>
              </nav>
              <div class="back-button-container back-button-container--section-${section.id}">

              </div>
              <article class="post__detail post__detail--section-${section.id}" data-post-id="${post.id}" data-section-id="${section.id}" style="border-color: ${section.style.borderColor};">
                <h1 class="post__detail-title post__detail-title--section-${section.id}" style="color: ${section.style.titleColor};">${escapeHtml(post.title || 'タイトル未設定')}</h1>
                <p class="post__detail-date post__detail-date--section-${section.id}" style="color: ${section.style.contentColor};">${escapeHtml(post.date || '')}</p>
                ${post.image ? `
                  <div class="post__detail-image post__detail-image--section-${section.id}">
                    <img src="${prefixImageUrl(post.image)}" alt="${escapeHtml(post.title)}" style="max-width:100%;">
                  </div>
                ` : ''}
                <div class="post__detail-content post__detail-content--section-${section.id}" style="color: ${section.style.contentColor};">${Array.isArray(post.blocks) ? renderBlocks(post.blocks, section.id) : escapeHtml(post.content || '')}</div>
              </article>
              <button class="post__back-button post__back-button--section-${section.id}" onclick="goBack()">
                ← 戻る
              </button>
            </div>
          `;
        } catch (err) {
          console.error('投稿詳細表示エラー:', err);
        }
      }

      async function viewAllPosts(sectionId, sectionName) {
        try {
          const section = allSections.find(s => s.id === sectionId);
          const sectionPosts = allPosts
            .filter(post => post.sectionId === sectionId)
            .sort((a, b) => {
              const dateA = new Date(a.date || 0);
              const dateB = new Date(b.date || 0);
              return dateB - dateA;
            });

          updateMVForSection(section);
          const container = document.getElementById('dynamic-sections');

          container.innerHTML = `
            <div class="section-list-container section-list-container--id-${section.id}">
              <nav class="breadcrumb breadcrumb--section-${section.id}">
                <a href="#" onclick="navigateTo(''); return false;" class="breadcrumb__link breadcrumb__link--home">ホーム</a> /
                <span class="breadcrumb__current">${escapeHtml(section.name)}</span>
              </nav>
              <div class="back-button-container back-button-container--section-${section.id}">
                <button class="back-button back-button--section-${section.id}" onclick="goBack()">
                  ← 戻る
                </button>
              </div>
              <section class="section section--list section--list-id-${section.id}" data-section-id="${section.id}" style="border-color: ${section.style.borderColor};">
                <h1 class="section__list-title section__list-title--id-${section.id}" style="color: ${section.style.titleColor};">${escapeHtml(section.name)} 一覧</h1>
                ${section.description ? `<p class="section__list-description section__list-description--id-${section.id}" style="color: ${section.style.contentColor};">${escapeHtml(section.description)}</p>` : ''}
                <div class="post__list post__list--section-${section.id}">
                  ${sectionPosts.length > 0
              ? sectionPosts.map(post => renderPostPreview(post, section.style)).join('')
              : `<p class="section__list-empty section__list-empty--id-${section.id}" style="color: ${section.style.contentColor};">このセクションにはまだ投稿がありません</p>`
            }
                </div>
              </section>
            </div>
          `;
        } catch (err) {
          console.error('セクション一覧表示エラー:', err);
        }
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      window.addEventListener('hashchange', handleRouting);
      window.addEventListener('load', () => {
        handleRouting();
      });

      renderSections();
    </script>
  </main>
  <footer class="footer">
    <div class="header__inner footer__inner">
      <h1 class="header__logo">
        <a href="/">WP FAKE</a>
      </h1>
    </div>
  </footer>
</body>

</html>
